import React from 'react'
import { Button, Text } from '../../components'
import S from '../../stitches.config'
import IssueList from './IssueList'
import { getRepoIssues, GetRepoIssuesData } from '../../api'
import { usePaginatedQuery } from 'react-query'
import { useParams } from 'react-router-dom'
import { AlertCircle } from 'react-feather'

type IssuesQueryOpenAction = {
    type: 'ISSUES_OPEN'
}

type IssuesQueryClosedAction = {
    type: 'ISSUES_CLOSED'
}

type IssuesQueryNextPageAction = {
    type: 'ISSUES_NEXT_PAGE'
}

type IssuesQueryAction =
    | IssuesQueryOpenAction
    | IssuesQueryClosedAction
    | IssuesQueryNextPageAction

type IssuesQueryState = {
    state: 'open' | 'closed'
    page: number
}

const initIssuesQuery: IssuesQueryState = {
    state: 'open',
    page: 1,
}

function issuesQueryReducer(
    state: IssuesQueryState,
    action: IssuesQueryAction
): IssuesQueryState {
    switch (action.type) {
        case 'ISSUES_OPEN': {
            return {
                state: 'open',
                page: 1,
            }
        }
        case 'ISSUES_CLOSED': {
            return {
                state: 'closed',
                page: 1,
            }
        }
        case 'ISSUES_NEXT_PAGE': {
            return {
                ...state,
                page: ++state.page,
            }
        }
        default: {
            return state
        }
    }
}

const ButtonState = S.styled(Button, {
    fontWeight: '$light',
})

function FilterIssuesState({
    currentState,
    ownState,
    ...otherProps
}: {
    currentState: string
    ownState: string
    children: React.ReactNode
    onClick: React.MouseEventHandler
}) {
    return currentState === ownState ? (
        <Text as="span" size="sm" {...otherProps} fontWeight="bold" />
    ) : (
        <ButtonState appearance="text" {...otherProps} />
    )
}

const FilterHeaderBox = S.styled('div', {
    borderLeftWidth: 1,
    borderRightWidth: 1,
    borderTopLeftRadius: 6,
    borderTopRightRadius: 6,
    padding: 16,
    backgroundColor: '#f6f8fa',
    border: '1px solid #e1e4e8',
    borderBottom: 'none',
})

export default function Issues() {
    const [issuesQuery, dispatch] = React.useReducer(
        issuesQueryReducer,
        initIssuesQuery
    )

    const params = useParams() as {
        repo: string
        owner: string
    }

    const { resolvedData: issues } = usePaginatedQuery(
        [
            getRepoIssues.key,
            {
                ...params,
                ...issuesQuery,
            },
        ],
        getRepoIssues
    ) as {
        resolvedData: GetRepoIssuesData
        isFetching: boolean
    }

    return (
        <div>
            <header>
                <FilterHeaderBox>
                    <FilterIssuesState
                        currentState={issuesQuery.state}
                        ownState="open"
                        onClick={() => dispatch({ type: 'ISSUES_OPEN' })}
                    >
                        <AlertCircle size={14} />
                        Open
                    </FilterIssuesState>
                    <FilterIssuesState
                        currentState={issuesQuery.state}
                        ownState="closed"
                        onClick={() => dispatch({ type: 'ISSUES_CLOSED' })}
                    >
                        Closed
                    </FilterIssuesState>
                </FilterHeaderBox>
                <IssueList items={issues} />
            </header>
        </div>
    )
}
